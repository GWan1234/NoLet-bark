var background=function(){"use strict";const e=globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome,t={"zh-CN":"zh_CN",en:"en",ja:"ja",ko:"ko"};let n="en";async function o(){try{const o=await e.storage.local.get("language");if(o.language&&Object.keys(t).includes(o.language))n=o.language;else{const o=function(){const e=navigator.language||"en";if(!e.startsWith("zh"))return"en";if(Object.keys(t).includes(e))return e;return"zh-CN"}();n=o,await e.storage.local.set({language:o})}console.debug("Background i18n 初始化完成，当前语言:",n)}catch(o){console.error("初始化 background i18n 失败:",o),n="en"}}function i(t,n){try{const o=e.i18n.getMessage(t,n);return o||(console.warn(`未找到i18n消息: ${t}`),t)}catch(o){return console.error(`获取i18n消息失败: ${t}`,o),t}}function r(){return crypto.randomUUID()}function a(){return function(e){const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=new Uint8Array(e);return crypto.getRandomValues(n),Array.from(n,e=>t[e%62]).join("")}(12)}function s(e){return(new TextEncoder).encode(e)}async function c(e,t,n){const o=s(t),i=s(n),r=s(e),a=await crypto.subtle.importKey("raw",new Uint8Array(o),{name:"AES-GCM"},!1,["encrypt"]),c=await crypto.subtle.encrypt({name:"AES-GCM",iv:new Uint8Array(i)},a,new Uint8Array(r)),l=new Uint8Array(c),d=new Uint8Array(i.length+l.length);return d.set(i),d.set(l,i.length),function(e){const t=String.fromCharCode(...new Uint8Array(e));return btoa(t)}(d.buffer)}async function l(e,t,n,o){const i={"Content-Type":"application/json; charset=utf-8"};n&&n.value&&(i.Authorization=n.value);let r={...e};if(o?.key){const e=a(),n=JSON.stringify({body:r.body,title:r.title,...Object.entries(r).filter(([e])=>!["body","title"].includes(e)).reduce((e,[t,n])=>({...e,[t]:n}),{})}),i=await c(n,o.key,e),{body:s,title:l,subtitle:d,...u}=r;r={...u,ciphertext:i},console.debug("API v2 加密请求:",{endpoint:t,plaintext:n,ciphertext:i})}else console.debug("API v2 明文请求:",{endpoint:t,payload:r});const s=await fetch(t,{method:"POST",mode:"cors",cache:"no-cache",headers:i,body:JSON.stringify(r)});if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const l=await s.json();return console.debug("API v2 请求成功:",l),l}async function d(e,t){return async function(e,t,n,o,i){const r=`${new URL(t).origin}/push`;if(!i||0===i.length){const{device_keys:t,...i}=e;return l(i,r,n,o)}const a=function(e){return e.reduce((e,t)=>{if(!t.server)return e;const n=t.server;return e[n]||(e[n]=[]),e[n].push(t),e},{})}(i);console.debug("设备分组:",a);const s=[],c=Object.entries(a).map(async([t,i])=>{const r=i.map(e=>e.deviceKey).filter(e=>void 0!==e),a=i[0].authorization||n,{devices:c,device_key:d,device_keys:u,...h}=e,g={...h,...r.length>1?{device_keys:r}:{device_key:r[0]}};try{const e=`${t}/push`,n=await l(g,e,a,o);return s.push(n),n}catch(m){throw console.error(`服务器 ${t} 批量推送失败:`,m),m}});return await Promise.all(c),{code:s.every(e=>200===e.code)?200:400,message:s.map(e=>e.message).join("; "),timestamp:Date.now()}}({body:e.message,id:e.uuid||r(),...Object.entries(e).filter(([e,t])=>!["apiURL","message","uuid","authorization","devices"].includes(e)&&("volume"!==e||5!==t&&"5"!==t)).reduce((e,[t,n])=>({...e,[t]:n}),{})},e.apiURL,e.authorization,t,e.devices)}function u(e,t){const n={message:e.message,autoCopy:e.autoCopy||"1",copy:e.copy||e.message,id:e.uuid||"",sound:e.sound||"",title:e.title,url:e.url,subtitle:e.subtitle,device_key:e.device_key,device_keys:e.device_keys?.join(","),level:e.level,volume:e.volume?.toString(),badge:e.badge?.toString(),call:e.call,icon:e.icon,group:e.group,isArchive:e.isArchive,action:e.action,delete:e.delete},o=Object.entries(n).filter(([e,t])=>void 0!==t).map(([e,t])=>({key:e,value:t}));return t?[{key:"ciphertext",value:"***"},...o]:o}const h={title:"",subtitle:"",image:"",level:"",volume:"5",badge:"",call:"",autoCopy:"1",copy:"",group:"",isArchive:"",url:"",action:""};JSON.stringify(h,null,2);const g=(e,t)=>t.some(t=>e instanceof t);let m,p;const y=new WeakMap,f=new WeakMap,w=new WeakMap;let v={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return y.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return I(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function _(e){v=e(v)}function b(e){return(p||(p=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(k(this),t),I(this.request)}:function(...t){return I(e.apply(k(this),t))}}function D(e){return"function"==typeof e?b(e):(e instanceof IDBTransaction&&function(e){if(y.has(e))return;const t=new Promise((t,n)=>{const o=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",r),e.removeEventListener("abort",r)},i=()=>{t(),o()},r=()=>{n(e.error||new DOMException("AbortError","AbortError")),o()};e.addEventListener("complete",i),e.addEventListener("error",r),e.addEventListener("abort",r)});y.set(e,t)}(e),g(e,m||(m=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,v):e)}function I(e){if(e instanceof IDBRequest)return function(e){const t=new Promise((t,n)=>{const o=()=>{e.removeEventListener("success",i),e.removeEventListener("error",r)},i=()=>{t(I(e.result)),o()},r=()=>{n(e.error),o()};e.addEventListener("success",i),e.addEventListener("error",r)});return w.set(t,e),t}(e);if(f.has(e))return f.get(e);const t=D(e);return t!==e&&(f.set(e,t),w.set(t,e)),t}const k=e=>w.get(e);function E(e,t,{blocked:n,upgrade:o,blocking:i,terminated:r}={}){const a=indexedDB.open(e,t),s=I(a);return o&&a.addEventListener("upgradeneeded",e=>{o(I(a.result),e.oldVersion,e.newVersion,I(a.transaction),e)}),n&&a.addEventListener("blocked",e=>n(e.oldVersion,e.newVersion,e)),s.then(e=>{r&&e.addEventListener("close",()=>r()),i&&e.addEventListener("versionchange",e=>i(e.oldVersion,e.newVersion,e))}).catch(()=>{}),s}const U=["get","getKey","getAll","getAllKeys","count"],L=["put","add","delete","clear"],C=new Map;function x(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(C.get(t))return C.get(t);const n=t.replace(/FromIndex$/,""),o=t!==n,i=L.includes(n);if(!(n in(o?IDBIndex:IDBObjectStore).prototype)||!i&&!U.includes(n))return;const r=async function(e,...t){const r=this.transaction(e,i?"readwrite":"readonly");let a=r.store;return o&&(a=a.index(t.shift())),(await Promise.all([a[n](...t),i&&r.done]))[0]};return C.set(t,r),r}_(e=>({...e,get:(t,n,o)=>x(t,n)||e.get(t,n,o),has:(t,n)=>!!x(t,n)||e.has(t,n)}));const A=["continue","continuePrimaryKey","advance"],T={},B=new WeakMap,S=new WeakMap,z={get(e,t){if(!A.includes(t))return e[t];let n=T[t];return n||(n=T[t]=function(...e){B.set(this,S.get(this)[t](...e))}),n}};async function*R(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;const n=new Proxy(t,z);for(S.set(n,t),w.set(n,k(t));t;)yield n,t=await(B.get(n)||t.continue()),B.delete(n)}function O(e,t){return t===Symbol.asyncIterator&&g(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===t&&g(e,[IDBIndex,IDBObjectStore])}_(e=>({...e,get:(t,n,o)=>O(t,n)?R:e.get(t,n,o),has:(t,n)=>O(t,n)||e.has(t,n)}));const P=new class{db=null;DB_NAME="NoLetSenderDB";DB_VERSION=1;async init(){this.db||(this.db=await E(this.DB_NAME,this.DB_VERSION,{upgrade(e){const t=e.createObjectStore("history",{keyPath:"id",autoIncrement:!0});t.createIndex("by-timestamp","timestamp",{unique:!0}),t.createIndex("by-uuid","uuid",{unique:!0})}}))}async addRecord(e){if(await this.init(),!this.db)throw new Error("数据库未初始化");const t=Date.now(),n=Intl.DateTimeFormat().resolvedOptions().timeZone,o=new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),i={...e,uuid:e.uuid,timestamp:t,timezone:n,createdAt:o};try{const e=await this.db.add("history",i);return{...i,id:e}}catch(r){if(r instanceof Error&&"ConstraintError"===r.name){let e=t+1;for(;;)try{const t={...i,timestamp:e},n=await this.db.add("history",t);return{...t,id:n}}catch(a){if(a instanceof Error&&"ConstraintError"===a.name){e++;continue}throw a}}throw r}}async getAllRecords(){if(await this.init(),!this.db)throw new Error("数据库未初始化");return(await this.db.getAll("history")).sort((e,t)=>t.timestamp-e.timestamp)}async deleteRecords(e){if(await this.init(),!this.db)throw new Error("数据库未初始化");const t=this.db.transaction("history","readwrite"),n=e.map(e=>t.store.delete(e));await Promise.all(n),await t.done}async getRecordByUuid(e){if(await this.init(),!this.db)throw new Error("数据库未初始化");try{return await this.db.getFromIndex("history","by-uuid",e)||null}catch(t){return console.error("根据UUID查询记录失败:",t),null}}async updateRecordStatus(e,t){if(await this.init(),!this.db)throw new Error("数据库未初始化");try{const n=await this.db.getFromIndex("history","by-uuid",e);if(!n)return console.error("未找到UUID对应的记录:",e),!1;const o={...n,status:t};return await this.db.put("history",o),!0}catch(n){return console.error("更新记录状态失败:",n),!1}}async exportRecords(){return await this.getAllRecords()}async importRecords(e){if(await this.init(),!this.db)throw new Error("数据库未初始化");let t=0,n=0,o=0;for(const r of e)try{if(await this.db.getFromIndex("history","by-uuid",r.uuid)){n++;continue}if(await this.db.getFromIndex("history","by-timestamp",r.timestamp)){let e=r.timestamp;for(;await this.db.getFromIndex("history","by-timestamp",e);)e++;r.timestamp=e}const{id:e,...o}=r;await this.db.add("history",o),t++}catch(i){console.error("导入记录失败:",i,r),o++}return{success:t,skipped:n,errors:o}}async clearAllRecords(){if(await this.init(),!this.db)throw new Error("数据库未初始化");await this.db.clear("history")}async searchRecords(e){const t=await this.getAllRecords(),n=e.toLowerCase();return t.filter(e=>e.body.toLowerCase().includes(n)||e.deviceName.toLowerCase().includes(n)||e.title&&e.title.toLowerCase().includes(n)||e.apiUrl.toLowerCase().includes(n))}};const N=new class{fileDb=null;FILE_DB_NAME="NoLetSenderFileDB";FILE_DB_VERSION=1;async close(){this.fileDb&&(this.fileDb.close(),this.fileDb=null,console.debug("文件缓存数据库连接已关闭"))}async destroy(){return await this.close(),new Promise((e,t)=>{console.debug("正在销毁文件缓存数据库...");const n=indexedDB.deleteDatabase(this.FILE_DB_NAME);n.onsuccess=()=>{console.debug("文件缓存数据库销毁成功"),e()},n.onerror=()=>{console.error("销毁文件缓存数据库失败:",n.error),t(n.error)},n.onblocked=()=>{console.warn("销毁数据库被阻塞，可能有其他连接未关闭"),setTimeout(()=>{t(new Error("数据库销毁被阻塞"))},5e3)}})}async init(){this.fileDb||(this.fileDb=await E(this.FILE_DB_NAME,this.FILE_DB_VERSION,{upgrade(e){const t=e.createObjectStore("fav",{keyPath:"id",autoIncrement:!0});t.createIndex("by-url","url",{unique:!1}),t.createIndex("by-timestamp","timestamp",{unique:!1}),t.createIndex("by-url-size",["url","size"],{unique:!0});const n=e.createObjectStore("img",{keyPath:"id",autoIncrement:!0});n.createIndex("by-pushID","pushID",{unique:!0}),n.createIndex("by-timestamp","timestamp",{unique:!1})}}))}async saveFavicon(e,t){if(await this.init(),!this.fileDb)throw new Error("文件缓存数据库未初始化");const n=Date.now(),o=t.byteLength,i=new Date(n).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1});try{const t=await this.fileDb.getFromIndex("fav","by-url-size",[e,o]);if(t)return console.debug("Favicon 已存在缓存中:",e),t}catch(a){}const r={url:e,timestamp:n,createdAt:i,size:o,content:t};try{const e=await this.fileDb.add("fav",r);return{...r,id:e}}catch(a){throw console.error("保存 favicon 失败:",a),a}}async getFavicon(e,t){if(await this.init(),!this.fileDb)throw new Error("文件缓存数据库未初始化");try{const n=await this.fileDb.getAllFromIndex("fav","by-url",e);if(0===n.length)return null;let o;if(1===n.length)o=n[0];else if(t){const e=n.filter(e=>e.timestamp<=t);if(0===e.length)return null;o=e.reduce((e,t)=>t.timestamp>e.timestamp?t:e)}else o=n.reduce((e,t)=>t.timestamp>e.timestamp?t:e);const i=new Blob([o.content]);return URL.createObjectURL(i)}catch(n){return console.error("获取 favicon 失败:",n),null}}async deleteFaviconsBefore(e){if(await this.init(),!this.fileDb)throw new Error("文件缓存数据库未初始化");const t=this.fileDb.transaction("fav","readwrite"),n=t.objectStore("fav").index("by-timestamp"),o=IDBKeyRange.upperBound(e),i=await n.openCursor(o),r=[];if(i)do{r.push(i.delete())}while(await i.continue());await Promise.all(r),await t.done}async saveImage(e,t,n){if(await this.init(),!this.fileDb)throw new Error("文件缓存数据库未初始化");const o=Date.now(),i=t.byteLength,r={url:e,timestamp:o,createdAt:new Date(o).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),size:i,content:t,pushID:n};try{const t=await this.fileDb.add("img",r);return console.debug("图片缓存保存成功:",{url:e,pushID:n,size:i}),{...r,id:t}}catch(a){if(a instanceof DOMException&&"ConstraintError"===a.name)try{const e=await this.fileDb.getFromIndex("img","by-pushID",n);if(e)return console.debug("Image 已存在缓存中 (pushID):",n),e}catch(s){console.error("查询现有图片记录失败:",s)}throw console.error("保存 image 失败:",a),a}}async getImageByPushID(e){if(await this.init(),!this.fileDb)throw new Error("文件缓存数据库未初始化");try{const t=await this.fileDb.getFromIndex("img","by-pushID",e);if(!t)return null;const n=new Blob([t.content]);return URL.createObjectURL(n)}catch(t){return console.error("获取 image 失败:",t),null}}async deleteImagesBefore(e){if(await this.init(),!this.fileDb)throw new Error("文件缓存数据库未初始化");const t=this.fileDb.transaction("img","readwrite"),n=t.objectStore("img").index("by-timestamp"),o=IDBKeyRange.upperBound(e),i=await n.openCursor(o),r=[];if(i)do{r.push(i.delete())}while(await i.continue());await Promise.all(r),await t.done}};async function F(t,n,o=!1){try{const i=(await e.storage.local.get("nolet_app_settings")).nolet_app_settings||{};if(!1===i.enableSystemNotifications)return;if(!0===i.keepEssentialNotifications&&!o)return;await e.notifications.create({type:"basic",iconUrl:"/icon/128.png",title:t,message:n})}catch(i){console.error("创建通知失败:",i)}}const j=null==(M=()=>{function a(e){const t={};if(!e.enableAdvancedParams)return t;try{const n=e.advancedParamsJson?JSON.parse(e.advancedParamsJson):{};return Object.keys(h).forEach(e=>{const o=h[e],i=n[e];void 0!==i&&i!==o&&""!==i&&(t[e]=i)}),console.debug("自定义参数差异:",t),t}catch(n){return console.error("解析自定义参数失败:",n),t}}function s(e,t){const n={...e};return[{condition:()=>!!t.title,removeKeys:["title"]},{condition:()=>!!t.url,removeKeys:["url"]},{condition:()=>!!t.copyContent,removeKeys:["copy"]},{condition:()=>!!t.autoCopy,removeKeys:["autoCopy"]},{condition:()=>!!t.level,removeKeys:["level"]},{condition:()=>"image"===t.contentType,removeKeys:["image"]}].forEach(e=>{e.condition()&&e.removeKeys.forEach(e=>delete n[e])}),n}async function c(t){try{const n=(await e.storage.local.get("nolet_app_settings")).nolet_app_settings||{};if(!n.enableFaviconIcon)throw new Error("Favicon 功能已关闭");const o=new URL(t).hostname,i=n.faviconApiUrl.replace("$domain$",o);if((await fetch(i,{method:"HEAD",cache:"force-cache"})).ok){const e=await fetch(i,{cache:"force-cache"});if(e.ok){const t=e.headers.get("content-type");if(t&&(t.startsWith("image/")||"application/octet-stream"===t))return console.debug(`Favicon 预加载 for ${o}: ${i}`),i}}return console.debug(`Favicon 不可用 for ${o}`),null}catch(n){return console.debug(`预加载 Favicon 失败 ${t}:`,n),null}}async function l(t){let n=!1;try{await P.addRecord(t),console.debug(i("save_history_record"),t,"(直接存储)"),n=!0}catch(o){console.warn("直接存储历史记录失败，使用暂存兜底:",o);try{const n=(await e.storage.local.get("nolet_history")).nolet_history||[];n.unshift(t),n.length>1e3&&n.splice(1e3),await e.storage.local.set({nolet_history:n}),console.debug(i("save_history_record"),t,"(暂存兜底)"),console.debug(i("current_history_total",[n.length.toString()]))}catch(r){console.error(i("save_history_failed"),r)}}}async function g(){try{e.contextMenus.removeAll();const t=await e.storage.local.get("nolet_app_settings"),n=(t.nolet_app_settings||{enableContextMenu:!0,enableInspectSend:!0}).enableInspectSend??!0,[o,r]=await Promise.all([e.storage.local.get("nolet_devices"),e.storage.local.get("nolet_default_device")]),a=o.nolet_devices||[],s=r.nolet_default_device||"";if(0===a.length)return;const c=a.find(e=>e.id===s)||a[0];n?e.contextMenus.create({id:"inspect-send",title:i("inspect_send",[c.alias]),contexts:["all"]}):(e.contextMenus.create({id:"send-selection",title:i("send_selection_to_device",[c.alias]),contexts:["selection"]}),e.contextMenus.create({id:"send-page",title:i("send_page_to_device",[c.alias]),contexts:["page"]}))}catch(t){console.error(i("update_context_menus_failed"),t)}}o(),e.storage.onChanged.addListener(e=>{if(e.language){const o=e.language.newValue;o&&Object.keys(t).includes(o)&&(n=o,console.debug("Background i18n 语言已更新:",n))}}),e.runtime.onMessage.addListener((t,n,o)=>{if("prefetchFavicon"===t.action)return c(t.url).then(e=>{o({success:!0,faviconUrl:e})}).catch(e=>{o({success:!1,error:e.message})}),!0;if("sendPush"===t.action)return async function(t,n,o,a,s,c,l,u,h){try{const i=(await e.storage.local.get("nolet_app_settings")).nolet_app_settings||{enableEncryption:!1},g=l?{id:c||r(),apiURL:t,deviceKey:t.split("/").filter(Boolean).pop()||"",server:new URL(t).origin,alias:"Default Device",timestamp:Date.now(),createdAt:(new Date).toISOString(),authorization:l}:void 0;let m;h?m=h:i.enableCustomAvatar&&i.noletAvatarUrl&&(m=i.noletAvatarUrl);const p={apiURL:t,message:n,sound:o,url:a,title:s,uuid:c,devices:u||(g?[g]:void 0),device_key:g?.deviceKey,device_keys:u?.map(e=>e.deviceKey).filter(Boolean),...l&&{authorization:l},...m&&{icon:m}};return await d(p,void 0)}catch(g){throw console.error(i("background_send_push_failed"),g),g}}(t.apiURL,t.message,t.sound,t.url,t.title,t.uuid,t.authorization,t.devices,t.icon).then(e=>{o({success:!0,data:e})}).catch(e=>{o({success:!1,error:e.message})}),!0;if("sendEncryptedPush"===t.action)return async function(t,n,o,a,s,c,l,u,h,g){try{const i=(await e.storage.local.get("nolet_app_settings")).nolet_app_settings||{enableEncryption:!1},m=u?{id:l||r(),apiURL:t,deviceKey:t.split("/").filter(Boolean).pop()||"",server:new URL(t).origin,alias:"Default Device",timestamp:Date.now(),createdAt:(new Date).toISOString(),authorization:u}:void 0;let p;g?p=g:i.enableCustomAvatar&&i.noletAvatarUrl&&(p=i.noletAvatarUrl);const y={apiURL:t,message:n,sound:a,url:s,title:c,uuid:l,devices:h||(m?[m]:void 0),device_key:m?.deviceKey,device_keys:h?.map(e=>e.deviceKey).filter(Boolean),...u&&{authorization:u},...p&&{icon:p}};return await d(y,o)}catch(m){throw console.error(i("background_send_encrypted_push_failed"),m),m}}(t.apiURL,t.message,t.encryptionConfig,t.sound,t.url,t.title,t.uuid,t.authorization,t.devices,t.icon).then(e=>{o({success:!0,data:e})}).catch(e=>{o({success:!1,error:e.message})}),!0;if("readClipboard"===t.action)return async function(){try{return await navigator.clipboard.readText()||""}catch(e){return console.error(i("read_clipboard_failed"),e),""}}().then(e=>{o(e)}).catch(e=>{o("")}),!0;if("send_content"===t.action)return Promise.all([e.storage.local.get("nolet_devices"),e.storage.local.get("nolet_default_device"),e.storage.local.get("nolet_app_settings")]).then(([c,h,g])=>{const m=c.nolet_devices||[],p=h.nolet_default_device||"",y=m.find(e=>e.id===p)||m[0],f=g.nolet_app_settings||{enableEncryption:!1};if(!y)return console.error(i("device_not_found")),F(i("nolet_sender_title"),i("device_not_found"),!0),void o({success:!1,error:i("device_not_found")});let w,v,_,b,D=t.title||"",I=t.content?.trim()||"",k=!1;switch(t.contentType){case"text":b="1";break;case"text-large":v=t.content?.trim()||void 0,I=t.isLastChunk?i("push.large_content.last_chunk"):i("push.large_content.not_last_chunk"),_=t.isLastChunk?void 0:"passive";break;case"image":case"url":w=t.content,b="1",v=void 0,I=void 0,k=!0}const E=r();let U;f.enableFaviconIcon&&t.icon?U=t.icon:f.enableCustomAvatar&&f.noletAvatarUrl&&(U=f.noletAvatarUrl);const L=s(a(f),{title:D,url:w,copyContent:v,autoCopy:b,level:_,contentType:t.contentType}),C={apiURL:y.apiURL,message:k?void 0:I,sound:f.sound,image:"image"===t.contentType?t.content:void 0,url:w||void 0,title:D||void 0,uuid:E,copy:v||void 0,devices:[y],...y.authorization&&{authorization:y.authorization},..._&&{level:_},...U&&{icon:U},...b&&{autoCopy:b},...L};let x=!1;(f.enableEncryption&&f.encryptionConfig?.key&&!k?(x=!0,d(C,f.encryptionConfig)):d(C,void 0)).then(r=>{console.log("发送成功:",r);const a=Date.now(),s=u(C,x);s.push({key:"device_key",value:y.deviceKey||""}),s.push({key:"device_keys",value:[y.deviceKey].filter(Boolean).join(",")||""}),l({id:Date.now(),uuid:E,timestamp:a,body:I,apiUrl:y.apiURL,deviceName:y.alias,parameters:s,responseJson:r,requestTimestamp:a,responseTimestamp:Date.now(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,method:"POST",title:D||void 0,sound:f.sound||void 0,url:w||void 0,isEncrypted:!k&&x,createdAt:new Date(a).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),inspectType:t.contentType,authorization:y.authorization}),("text-large"!==t.contentType||t.isLastChunk)&&F("text-large"===t.contentType?i("nolet_sender_title")+" (Large Content)":i("nolet_sender_title"),i("sent_to_device",[y.alias])),"image"===t.contentType&&f.enableFileCache&&t.content&&n.tab?.id&&e.tabs.sendMessage(n.tab.id,{action:"cacheImage",imageUrl:t.content,pushID:E}).catch(e=>{console.debug("发送缓存图片消息失败:",e)}),o({success:!0,data:r,pushID:E})}).catch(e=>{console.error("发送失败:",e);const t=Date.now(),n={code:-1,message:e instanceof Error?e.message:i("error_unknown"),timestamp:Date.now()};l({id:Date.now(),uuid:E,timestamp:t,body:I,apiUrl:y.apiURL,deviceName:y.alias,parameters:[],responseJson:n,requestTimestamp:t,responseTimestamp:Date.now(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,method:"POST",title:D||void 0,sound:f.sound||void 0,url:w||void 0,isEncrypted:!k&&x,createdAt:new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),authorization:y.authorization}),F(i("nolet_sender_title"),i("send_failed_check_network"),!0),o({success:!1,data:n})})}),!0;if("saveImageCache"===t.action){const{imageUrl:e,imageData:n,pushID:i}=t;if(!e||!n||!i)return o({success:!1,error:"缺少必要参数"}),!0;try{if(!(n instanceof ArrayBuffer))throw new Error("图片数据类型错误，期望 ArrayBuffer");N.saveImage(e,n,i).then(e=>{console.debug("图片缓存保存成功:",e),o({success:!0,record:e})}).catch(e=>{console.error("保存图片缓存失败:",e),o({success:!1,error:e.message})})}catch(h){console.error("处理图片数据失败:",h),o({success:!1,error:h instanceof Error?h.message:"处理图片数据失败"})}return!0}if("saveImageCacheBase64"===t.action){const{imageUrl:e,imageData:n,pushID:i}=t;if(!e||!n||!i)return o({success:!1,error:"缺少必要参数"}),!0;try{if("string"!=typeof n)throw new Error("图片数据类型错误，期望 base64 字符串");const t=n.split(",")[1];if(!t)throw new Error("无效的 base64 数据");const r=atob(t),a=new ArrayBuffer(r.length),s=new Uint8Array(a);for(let e=0;e<r.length;e++)s[e]=r.charCodeAt(e);N.saveImage(e,a,i).then(e=>{console.debug("图片缓存保存成功 (base64):",e),o({success:!0,record:e})}).catch(e=>{console.error("保存图片缓存失败 (base64):",e),o({success:!1,error:e.message})})}catch(h){console.error("处理 base64 图片数据失败:",h),o({success:!1,error:h instanceof Error?h.message:"处理图片数据失败"})}return!0}if("fetchAndCacheImage"===t.action){const{imageUrl:e,pushID:n}=t;return e&&n?(fetch(e).then(e=>{if(!e.ok)throw new Error(`HTTP ${e.status}`);return e.arrayBuffer()}).then(t=>(console.debug("Background 获取图片数据成功，大小:",t.byteLength,"bytes"),N.saveImage(e,t,n))).then(e=>{console.debug("图片缓存保存成功 (background):",e),o({success:!0,record:e})}).catch(e=>{console.error("Background 获取并缓存图片失败:",e),o({success:!1,error:e.message||"Background 获取图片失败"})}),!0):(o({success:!1,error:"缺少必要参数"}),!0)}}),e.runtime.onConnect.addListener(e=>{"imageCache"===e.name&&(e.onMessage.addListener(async t=>{if("saveImageCache"===t.action){const{imageUrl:o,imageData:i,pushID:r}=t;try{if(!o||!i||!r)throw new Error("缺少必要参数");if(!(i instanceof ArrayBuffer))throw new Error("图片数据类型错误，期望 ArrayBuffer");const t=await N.saveImage(o,i,r);console.debug("图片缓存保存成功 (Port):",t),e.postMessage({success:!0,record:t})}catch(n){console.error("Port 保存图片缓存失败:",n),e.postMessage({success:!1,error:n instanceof Error?n.message:"保存失败"})}}}),e.onDisconnect.addListener(()=>{console.debug("图片缓存 Port 连接断开")}))}),e.commands.onCommand.addListener(async t=>{console.debug(i("shortcut_triggered"),t),"send-clipboard"===t&&await async function(){try{console.debug(i("shortcut_triggered"));const[t,n]=await Promise.all([e.storage.local.get("nolet_devices"),e.storage.local.get("nolet_default_device")]),o=t.nolet_devices||[],r=n.nolet_default_device||"",a=o.find(e=>e.id===r)||o[0];if(!a)return console.debug(i("device_not_found_window")),await e.windows.create({url:e.runtime.getURL("/popup.html?mode=window&autoAddDevice=true"),type:"popup",width:380,height:660,left:0,top:0,focused:!0}),void F(i("nolet_sender_title"),i("device_not_found"),!0);console.debug(i("creating_small_window")),await e.windows.create({url:e.runtime.getURL("/popup.html?mode=window"),type:"popup",width:380,height:660,left:0,top:0,focused:!0}),setTimeout(()=>{e.runtime.sendMessage({action:"shortcut-triggered",defaultDevice:a}).catch(e=>{console.debug(i("send_message_to_window_failed",[e.toString()])),F(i("nolet_sender_title"),i("notification_shortcut_with_device",[a.alias]),!0)})},300)}catch(t){console.error(i("shortcut_processing_failed"),t),F(i("nolet_sender_title"),i("shortcut_processing_failed"),!0)}}()}),e.omnibox&&(e.omnibox.onInputEntered.addListener(async t=>{t.trim()&&await async function(t){try{const[n,o,c]=await Promise.all([e.storage.local.get("nolet_devices"),e.storage.local.get("nolet_default_device"),e.storage.local.get("nolet_app_settings")]),h=n.nolet_devices||[],g=o.nolet_default_device||"",m=h.find(e=>e.id===g)||h[0],p=c.nolet_app_settings||{enableEncryption:!1};if(!m)return await e.storage.local.set({nolet_omnibox_message:t}),F(i("nolet_sender_title"),i("device_not_found"),!0),void(await e.windows.create({url:e.runtime.getURL("/popup.html?mode=window&autoAddDevice=true"),type:"popup",width:380,height:660,left:0,top:0,focused:!0}));const y=r(),f=s(a(p),{}),w={apiURL:m.apiURL,message:t,sound:p.sound,title:void 0,uuid:y,devices:[m],...m.authorization&&{authorization:m.authorization},...p.enableCustomAvatar&&p.noletAvatarUrl&&{icon:p.noletAvatarUrl},...f};let v=!1,_="GET";const b=p.enableEncryption&&p.encryptionConfig?.key?(v=!0,_="POST",d(w,p.encryptionConfig)):(_="POST",d(w,void 0)),D=await b,I=Date.now(),k=u(w,v);k.push({key:"device_key",value:m.deviceKey||""}),k.push({key:"device_keys",value:[m.deviceKey].filter(Boolean).join(",")||""});const E={id:Date.now(),uuid:y,timestamp:I,body:t,apiUrl:m.apiURL,deviceName:m.alias,parameters:k,responseJson:D,requestTimestamp:I,responseTimestamp:Date.now(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,method:_,title:void 0,sound:p.sound||void 0,url:void 0,isEncrypted:v,createdAt:new Date(I).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),inspectType:"omnibox",authorization:m.authorization};await l(E),F(i("nolet_sender_title"),i("sent_to_device",[m.alias]))}catch(n){console.error("地址栏推送发送失败:",n),F(i("nolet_sender_title"),i("send_failed_check_network"),!0)}}(t.trim())}),e.omnibox.onInputChanged.addListener((t,n)=>{t.trim()&&e.omnibox.setDefaultSuggestion({description:i("omnibox_send_push")})})),e.runtime.onInstalled.addListener(()=>{console.debug(i("extension_installed")),g()}),e.runtime.onStartup.addListener(()=>{g()}),e.storage.onChanged.addListener(e=>{(e.nolet_devices||e.nolet_app_settings)&&g()}),e.contextMenus.onClicked.addListener(async(t,n)=>{let o="",h="",m="",p=null,y={};try{const[w,v,_]=await Promise.all([e.storage.local.get("nolet_devices"),e.storage.local.get("nolet_default_device"),e.storage.local.get("nolet_app_settings")]),b=w.nolet_devices||[],D=v.nolet_default_device||"";if(p=b.find(e=>e.id===D)||b[0],y=_.nolet_app_settings||{enableEncryption:!1},"toggle-speed-mode"===t.menuItemId){const t=!y.enableSpeedMode,n={...y,enableSpeedMode:t};return await e.storage.local.set({nolet_app_settings:n}),F(i("nolet_sender_title"),i(t?"enable_speed_mode":"disable_speed_mode"),!0===t),void g()}if(!p)return console.error(i("device_not_found")),void F(i("nolet_sender_title"),i("device_not_found"),!0);if(console.debug("info",t),"send-selection"===t.menuItemId&&t.selectionText)o=t.selectionText;else if("send-page"===t.menuItemId&&n?.url)h=n.title||"Web",o=n.url,m=n.url;else if("send-link"===t.menuItemId&&t.linkUrl)h=t.linkText||"Link",o=t.linkUrl,m=t.linkUrl;else if("inspect-send"===t.menuItemId){if(console.log("Right Click Context Info:",{info:t,tab:n,mediaType:t.mediaType,pageUrl:t.pageUrl,frameUrl:t.frameUrl,srcUrl:t.srcUrl,linkUrl:t.linkUrl,linkText:t.linkText,selectionText:t.selectionText,editable:t.editable,menuItemId:t.menuItemId,modifiers:t.modifiers,button:t.button,elementInfo:null}),t.pageUrl&&!t.pageUrl.startsWith("http://")&&!t.pageUrl.startsWith("https://"))return;return void(n&&n.id&&e.tabs.sendMessage(n.id,{action:"show_dialog",contextInfo:t}).catch(o=>{const i={url:n.url,title:n.title,selectionText:t.selectionText,linkText:t.linkText,linkUrl:t.linkUrl};e.storage.local.set({nolet_url_data:i}).then(()=>{e.windows.create({url:e.runtime.getURL("/popup.html?mode=window&useUrlDialog=true"),type:"popup",width:380,height:660,left:0,top:0,focused:!0})})}))}if(o){const e=Date.now();let g,w="GET",v=!1,_=[];const b=r();let D,I=null;if("send-page"===t.menuItemId||"send-selection"===t.menuItemId)try{const e=n?.url;e&&(I=await c(e))}catch(f){console.debug("预加载favicon失败:",f)}y.enableFaviconIcon&&I?D=I:y.enableCustomAvatar&&y.noletAvatarUrl&&(D=y.noletAvatarUrl);const k=s(a(y),{title:h,url:m}),E={apiURL:p.apiURL,message:o,sound:y.sound,url:m,title:h,uuid:b,devices:[p],device_key:p.deviceKey,device_keys:[p.deviceKey].filter(Boolean),...p.authorization&&{authorization:p.authorization},...D&&{icon:D},...k};y.enableEncryption&&y.encryptionConfig?.key?(w="POST",v=!0,g=await d(E,y.encryptionConfig)):(w="POST",g=await d(E,void 0)),_=u(E,v);const U=Date.now(),L=Intl.DateTimeFormat().resolvedOptions().timeZone,C=new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),x={id:Date.now(),uuid:b,timestamp:e,body:o,apiUrl:p.apiURL,deviceName:p.alias,parameters:_,responseJson:g,requestTimestamp:e,responseTimestamp:U,timezone:L,method:w,title:h||void 0,sound:y.sound||void 0,url:m||void 0,isEncrypted:v,createdAt:C,authorization:p.authorization};await l(x),F(i("nolet_sender_title"),i("sent_to_device",[p.alias]))}}catch(f){if(console.error(i("send_failed_check_network"),f),o&&p){const e=Date.now(),t={code:-1,message:f instanceof Error?f.message:i("error_unknown"),timestamp:Date.now()},n={id:Date.now(),uuid:r(),timestamp:e,body:o,apiUrl:p.apiURL,deviceName:p.alias,parameters:[],responseJson:t,requestTimestamp:e,responseTimestamp:Date.now(),timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,method:"GET",title:h||void 0,sound:y.sound||void 0,url:m||void 0,isEncrypted:!1,createdAt:new Date(e).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}),authorization:p.authorization};await l(n)}F(i("nolet_sender_title"),i("send_failed_check_network"),!0)}})})||"function"==typeof M?{main:M}:M;var M;const K=(...e)=>{console.error};let q;try{q=j.main(),q instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch($){throw K("The background crashed on startup!"),$}return q}();
