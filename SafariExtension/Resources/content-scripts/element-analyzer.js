var elementAnalyzer=function(){"use strict";const n=globalThis.browser?.runtime?.id?globalThis.browser:globalThis.chrome,e={matches:["http://*/*","https://*/*"],main(){function e(e,t){try{const o=n.i18n.getMessage(e,t);return o||(console.warn(`未找到i18n消息: ${e}`),e)}catch(o){return console.error(`获取i18n消息失败: ${e}`,o),e}}let t=0,o=0,r=[],a=!1,i=null;document.addEventListener("contextmenu",function(n){t=n.clientX,o=n.clientY,r=function(n,e){const t=[];function o(n,e,t){const r=[];if(n.elementsFromPoint){const a=Array.from(n.elementsFromPoint(e,t));r.push(...a),a.forEach(n=>{if(n.shadowRoot){const a=o(n.shadowRoot,e,t);r.push(...a)}})}else{let a=n.elementFromPoint(e,t);if(a&&(r.push(a),a.shadowRoot)){const n=o(a.shadowRoot,e,t);r.push(...n)}}return r}const r=o(document,n,e);t.push(...r);return Array.from(new Set(t))}(t,o)}),n.runtime.onMessage.addListener(s=>{if("show_dialog"===s.action)try{return a?Promise.resolve({success:!1,error:"对话框已打开"}):(a=!0,function(s){const c=window.location.href;n.runtime.sendMessage({action:"prefetchFavicon",url:c}).then(n=>{n?.success&&n?.faviconUrl?(i=n.faviconUrl,console.debug("Favicon 预加载 by background:",i)):(i=null,console.debug("Favicon 预加载 by background 失败或不可用"))}).catch(n=>{console.debug("Favicon 预加载 by background 错误:",n),i=null});const l={link:e("link_address"),unknownError:e("error_unknown"),parseHtmlError:e("parse_html_error"),selectContentToSend:e("select_content_to_send"),close:e("close"),targetInfo:e("target_info"),linkAddress:e("link_address"),sendLink:e("send_link"),selectedText:e("selected_text"),sendSelectedText:e("send_selected_text"),imageContent:e("image_content"),imageLink:e("image_link"),sendImageLink:e("send_image_link"),imageLinkInvalid:e("image_link_invalid"),altText:e("alt_text"),sendAltText:e("send_alt_text"),image:e("image"),imageSource:e("image_source"),reloadPreview:e("reload_preview"),textContent:e("text_content"),tag:e("tag"),backgroundImage:e("background_image"),currentElement:e("current_element"),parentElement:e("parent_element"),currentElementText:e("current_element_text"),noParentElement:e("no_parent_element"),sendCurrentElementText:e("send_current_element_text"),parentElementText:e("parent_element_text"),sendParentElementText:e("send_parent_element_text"),pageLink:e("page_link"),pageTitle:e("page_title"),sendPageLink:e("send_page_link"),text_length_tip:e("text_length_tip")};try{const e=async(e,t,o)=>{if(!t.trim())return;const r=1500,a=E(".dialog-container");if("text"===e&&t.length>r){e="text-large";const o=[];let c=0;for(;c<t.length;){let n=Math.min(c+r,t.length);if(n<t.length){let e=-1;const o=t.lastIndexOf("\n",n),r=t.lastIndexOf(" ",n);-1!==o&&o>n-100&&(e=o),-1!==r&&r>n-50&&(-1===e||r>e)&&(e=r),-1!==e&&e>c&&(n=e)}o.push(t.substring(c,n)),c=n,"\n"!==t[c]&&" "!==t[c]||c++}const l=o.length,d=n=>new Promise(e=>setTimeout(e,n));for(let t=0;t<o.length;t++){a&&a.classList.add("fetching");try{t>0&&await d(200);const r=new Promise((n,e)=>setTimeout(()=>e(new Error("请求超时")),1e4)),s={action:"send_content",contentType:e,content:o[t],title:`[${t+1}/${l}] Large Content ${t!==o.length-1?"🔇":""}`,copyContent:o[t],isLastChunk:t===o.length-1};i&&(s.icon=i);const c=await Promise.race([n.runtime.sendMessage(s),r]);if(a&&a.classList.remove("fetching"),!c?.success||200!==c?.data?.code)return console.error("发送失败:",c),void alert(JSON.stringify(c));t===o.length-1&&T()}catch(s){return a&&a.classList.remove("fetching"),void console.error("发送请求出错:",s)}}}else{a&&a.classList.add("fetching");try{const r=new Promise((n,e)=>setTimeout(()=>e(new Error("请求超时")),1e4)),s={action:"send_content",contentType:e,content:t,title:o,copyContent:t};i?(s.icon=i,console.debug("发送消息将包含 Icon:",i)):console.debug("发送消息将不包含 Icon");const c=await Promise.race([n.runtime.sendMessage(s),r]);a&&a.classList.remove("fetching"),c?.success&&200===c?.data?.code?T():(console.error("发送失败:",c),alert(JSON.stringify(c)))}catch(s){a&&a.classList.remove("fetching"),console.error("发送请求出错:",s)}}};let c,g=r.find(n=>"img"===n.tagName.toLowerCase());if(g||(g=function(n,e){const t=[];function o(n){const e=[];n.querySelectorAll("img").forEach(n=>e.push(n));return n.querySelectorAll("*").forEach(n=>{n.shadowRoot&&e.push(...o(n.shadowRoot))}),e}return o(document).forEach(o=>{const r=o.getBoundingClientRect();n>=r.left&&n<=r.right&&e>=r.top&&e<=r.bottom&&t.push(o)}),t}(t,o)[0]),!g)for(const n of r)try{const e=window.getComputedStyle(n);let t=e.backgroundImage;if(t&&"none"!==t||(t=e.background),t&&"none"!==t){const n=t.match(/url\(['"]?(.*?)['"]?\)/i);if(n&&n[1]){if(c=n[1],c.startsWith("/")){c=`${window.location.origin}${c}`}break}}if(!c){const e=n.getAttribute("style");if(e){const n=e.match(/background(-image)?:\s*url\(['"]?(.*?)['"]?\)/i);if(n&&n[2]){if(c=n[2],c.startsWith("/")){c=`${window.location.origin}${c}`}break}}}}catch(d){console.warn("处理元素背景图片时出错:",d)}const p=r.length>0?r[0]:null,u=window.location.href,b=document.createElement("div"),f=b.attachShadow({mode:"closed"});document.documentElement.appendChild(b);let h="";if(g||c){const n=g?.getAttribute("srcset");let e;if(n&&n.trim())try{const t=n.split(",").filter(n=>n&&n.trim()).map(n=>{const e=n.trim().split(/\s+/),t=e[0]||"",o=e[1]||"";let r=0;if(o)if(o.endsWith("w")){const n=parseInt(o);r=isNaN(n)?0:n}else if(o.endsWith("x")){const n=parseFloat(o);r=isNaN(n)?0:1e3*n}return{url:t,weight:r}}).filter(n=>n.url);if(t.length>0){if(t.every(n=>0===n.weight))e=t[0].url;else{const n=t.reduce((n,e)=>e.weight>n.weight?e:n,t[0]);e=n?.url||t[0]?.url}}}catch(m){console.warn("解析srcset时出错:",m);try{const t=n.split(",")[0]?.trim().split(/\s+/)[0];t&&(e=t)}catch(d){}}const t=g?e||g.currentSrc||g.src:c,o=g&&g.alt||"",r=g?`&lt;img&gt; ${l.tag||"标签"}`:`${l.backgroundImage||"背景图片"}`,a=g&&g.naturalWidth?`${g.naturalWidth} × ${g.naturalHeight}`:"";h=`<div class="option-container"><div class="section-title">${l.imageContent||"图片内容"}</div><div class="image-content-box"><div class="form-area"><div class="input-group img-input-container"><label for="img-src">${l.imageLink||"图片链接"}:</label><textarea id="img-src" class="textarea" spellcheck="false" autocomplete="off">${t}</textarea><button class="btn btn-primary send-img-src">${l.sendImageLink||"发送图片链接"}</button><div class="img-message" style="visibility: hidden; color: #f44336; font-size: 0.75em; margin-top: 0.25em;">${l.imageLinkInvalid||"只能发送http或https开头的图片链接"}</div></div>${o?`<div class="input-group"><label for="img-alt">${l.altText||"替代文本"}:</label><textarea id="img-alt" class="textarea" spellcheck="false" autocomplete="off">${o}</textarea><button class="btn btn-primary send-img-alt">${l.sendAltText||"发送替代文本"}</button></div>`:""}</div><div class="preview-area"><div class="img-preview"><div class="thumbnail-container"><img src="${t}" alt="${o||l.image||"图片"}" title="${l.imageSource||"图片来源"}: ${r}" class="thumbnail">${a?`<div class="img-size">${a}</div>`:""}</div></div><button class="btn btn-secondary reload-preview">${l.reloadPreview||"重新加载预览"}</button></div></div></div>`}let v="";if(p&&p.innerText&&p.innerText.trim()){const n=p.parentElement,e=n?n.innerText:l.noParentElement||"无父元素";v=`<div class="option-container"><div class="section-title">${l.textContent||"文字内容"}</div><div class="tabs"><div class="tab tab-current active">${l.currentElement||"当前元素"}</div><div class="tab tab-parent">${l.parentElement||"父元素"}</div></div><div class="tab-content"><div class="tab-pane current-content active"><div class="input-group"><label for="current-text">${l.currentElementText||"当前元素文本"}:</label><textarea id="current-text" class="textarea" spellcheck="false" autocomplete="off">${p.innerText}</textarea><div style="display: flex; justify-content: space-between; align-items: center;"><button class="btn btn-primary send-current-text">${l.sendCurrentElementText||"发送当前元素文本"}</button><span style="color: var(--text-secondary); font-size: 0.625em;">${l.text_length_tip||"文本如果过长，可能会分段发送"}</span></div></div></div><div class="tab-pane parent-content"><div class="input-group"><label for="parent-text">${l.parentElementText||"父元素文本"}:</label><textarea id="parent-text" class="textarea" spellcheck="false" autocomplete="off">${e}</textarea><div style="display: flex; justify-content: space-between; align-items: center;"><button class="btn btn-primary send-parent-text">${l.sendParentElementText||"发送父元素文本"}</button><span style="color: var(--text-secondary); font-size: 0.625em;">${l.text_length_tip||"文本如果过长，可能会分段发送"}</span></div></div></div></div></div>`}const x=`<div class="option-container"><div class="section-title">${l.pageLink||"页面链接"}</div><div class="input-group"><label for="page-title">${l.pageTitle||"页面标题"}:</label><input type="text" id="page-title" class="input" value="${document.title}" spellcheck="false" autocomplete="off"></div><div class="input-group"><label for="page-url">${l.pageLink||"页面链接"}:</label><textarea id="page-url" class="textarea" spellcheck="false" autocomplete="off">${u}</textarea><button class="btn btn-primary send-page-url">${l.sendPageLink||"发送页面链接"}</button></div></div>`;let y="";if(s){const n=s.linkUrl,e=s.selectionText;(n||e)&&(y=`<div class="option-container"><div class="section-title">${l.targetInfo||"目标信息"}</div>${n?`<div class="input-group"><label for="context-link-url">${l.linkAddress||"链接地址"}:</label><textarea id="context-link-url" class="textarea" spellcheck="false" autocomplete="off">${s.linkUrl||""}</textarea>${s.linkUrl?`<button class="btn btn-primary send-context-link">${l.sendLink||"发送链接"}</button>`:""}</div>`:""}${e?`<div class="input-group"><label for="context-selection">${l.selectedText||"选中文本"}:</label><textarea id="context-selection" class="textarea" spellcheck="false" autocomplete="off">${s.selectionText||""}</textarea>${s.selectionText?`<button class="btn btn-primary send-context-selection">${l.sendSelectedText||"发送选中文本"}</button>`:""}</div>`:""}</div>`)}const w=`<div class="nolet-sender-root"><div class="dialog-container"><div class="dialog"><div class="dialog-title-container"><h2 class="dialog-title">${l.selectContentToSend}</h2><button class="close-btn" title="${l.close}"><svg viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path></svg></button></div><div class="dialog-body">${y}${h}${v}${x}</div></div></div></div>`,k=":host{font-size:14px;--primary:#1976d2;--primary-dark:#1976d2;--primary-darker:#1976d2;--primary-light:rgba(33, 150, 243, 0.08);--primary-text:#ffffff;--secondary:#f50057;--secondary-dark:#c51162;--secondary-darker:#880e4f;--secondary-light:rgba(245, 0, 87, 0.08);--secondary-text:#ffffff;--surface:#ffffff;--background:#fafafa;--text-primary:rgba(0, 0, 0, 0.87);--text-secondary:rgba(0, 0, 0, 0.6);--border:#e0e0e0;--border-dark:#bdbdbd;--error:#d32f2f}*{box-sizing:border-box;font-family:'Roboto', Arial, Helvetica, sans-serif;margin:0;padding:0;scrollbar-width:thin;scrollbar-color:#c1c1c1 #f1f1f1}.nolet-sender-root{all:initial;font-family:inherit;font-size:1em;line-height:1.5;color:inherit;position:fixed;inset:0;z-index:2147483647;contain:layout style}.dialog-container{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background-color:rgba(33, 33, 33, 0.5);opacity:1;transition:opacity 312ms ease}.dialog-container.closing{opacity:0}.dialog{background-color:var(--surface, #fff);border-radius:0.75em;border:1px solid rgba(0, 0, 0, 0.36);box-shadow:0px 11px 15px -7px rgba(0,0,0,0.2), 0px 24px 38px 3px rgba(0,0,0,0.14), 0px 9px 46px 8px rgba(0,0,0,0.12);width:90%;max-width:32em;max-height:90vh;position:relative;display:flex;flex-direction:column;overflow:hidden}.dialog-title-container{display:flex;align-items:center;justify-content:space-between;padding:1em 1.5em;border-bottom:1px solid var(--border, #e0e0e0);min-height:3.5em;flex-shrink:0;user-select:none;background-color:var(--primary, #1976d2)}.dialog-body{padding:1em;overflow-y:auto;flex:1;display:flex;flex-direction:column;gap:1em;background-color:var(--background, #fafafa);max-height:calc(90vh - 3.5em - 2em);scrollbar-width:thin;scrollbar-color:#c1c1c1 #f1f1f1}.dialog-body::-webkit-scrollbar{width:8px}.dialog-body::-webkit-scrollbar-track{background:#f1f1f1;border-radius:4px}.dialog-body::-webkit-scrollbar-thumb{background:#c1c1c1;border-radius:4px}.dialog-body::-webkit-scrollbar-thumb:hover{background:#a8a8a8}.close-btn{position:relative;border:none;background:none;font-size:1em;cursor:pointer;color:var(--primary-text, #ffffff);width:1.5em;height:1.5em;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:background-color 0.2s;margin-left:0.5em}.close-btn:hover{background-color:var(--primary-dark, #1565c0);opacity:0.8;scale:1.1}.close-btn:active{transition:opacity 0.2s;opacity:0.6}.close-btn svg{width:100%;height:100%;fill:currentColor}.dialog-title{font-size:1.25em;font-weight:400;margin:0;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--primary-text, #ffffff)}.options-container{display:flex;flex-direction:column;gap:1em}.option-container{border:1px solid var(--border, #e0e0e0);border-radius:0.875em;padding:1.25em;background-color:var(--surface, #ffffff);box-shadow:0 1px 3px rgba(0, 0, 0, 0.1)}.section-title{font-weight:600;font-size:1em;margin-bottom:0.5em;color:var(--text-primary, #424242);user-select:none}.empty-message{padding:1em;color:var(--text-secondary, #9e9e9e);text-align:center;font-style:italic}.image-content-box{display:flex;flex-direction:row;gap:1em}.preview-area{margin-bottom:1em}.img-preview{display:flex;gap:1em;margin-bottom:0.75em}.thumbnail-container{flex-shrink:0;width:7.5em;height:7.5em;display:flex;align-items:center;justify-content:center;border:1px solid var(--border, #e0e0e0);background-color:#f5f5f5;position:relative;overflow:hidden}.thumbnail{max-width:100%;max-height:100%;object-fit:contain}.img-size{position:absolute;bottom:0.25em;right:0.5em;font-size:0.625em;color:var(--text-secondary, #616161);background-color:rgba(255, 255, 255, 0.8);padding:0 0.25em;border-radius:0.25em;user-select:none}.form-area{flex:1;display:flex;flex-direction:column;gap:1em}.img-input-container{position:relative}.img-message{position:absolute;bottom:-1.8em;width:100%;background-color:var(--surface, #fff)}.input-group{display:flex;flex-direction:column;gap:0.625em;margin-bottom:0.75em}.input-group:last-child{margin-bottom:0}label{font-weight:500;font-size:0.875em;color:var(--text-primary, #424242);user-select:none}.input,.textarea{width:100%;padding:0.5em 0.75em;border-radius:0.375em;border:1px solid var(--border-dark, #bdbdbd);font-size:0.875em;background-color:var(--surface, #fff);color:var(--text-primary, #212121);font-family:monospace}.textarea{height:4em;resize:vertical;font-family:monospace}#img-src{height:calc(105px - 2.25em)}#current-text,#parent-text{height:8em}#context-selection{height:3em}.btn{position:relative;align-self:flex-start;padding:0 1em;height:2.25em;min-width:4em;border-radius:0.75em;cursor:pointer;font-size:0.875em;font-weight:400;line-height:2.25em;text-align:center;overflow:hidden;outline:none;border:none;user-select:none;vertical-align:middle;transition:box-shadow 0.2s, background-color 0.2s}.btn-primary{background-color:var(--primary, #1976d2);color:var(--primary-text, white);box-shadow:0 1px 2px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08)}.btn-primary:hover{background-color:var(--primary-dark, #1565c0);box-shadow:0 2px 4px rgba(0, 0, 0, 0.1), 0 2px 5px rgba(0, 0, 0, 0.06)}.btn-primary:active{background-color:var(--primary-darker, #0d47a1);box-shadow:0 1px 2px rgba(0, 0, 0, 0.12), 0 1px 3px rgba(0, 0, 0, 0.08)}.btn-secondary{background-color:var(--secondary-light, rgba(245, 0, 87, 0.08));color:var(--secondary, #f50057);border:1px solid var(--secondary, #f50057)}.btn-secondary:hover{background-color:var(--secondary-light, rgba(245, 0, 87, 0.12));opacity:0.9}.btn-secondary:active{background-color:var(--secondary-light, rgba(245, 0, 87, 0.16));opacity:0.7}.btn::before{content:\"\";position:absolute;top:0;left:0;right:0;bottom:0;background-color:currentColor;opacity:0;transition:opacity 0.2s}.btn:hover::before{opacity:0.08}.btn:focus::before{opacity:0.12}.btn:active::before{opacity:0.16}.btn::after{content:\"\";position:absolute;left:50%;top:50%;border-radius:50%;padding:50%;width:32px;height:32px;background-color:currentColor;opacity:0;transform:translate(-50%, -50%) scale(1);transition:opacity 1s, transform 0.5s}.btn:active::after{opacity:0.16;transform:translate(-50%, -50%) scale(0);transition:transform 0s}.fetching .btn,.btn:disabled{color:rgba(0, 0, 0, 0.38);background-color:rgba(0, 0, 0, 0.12);box-shadow:none;cursor:default;pointer-events:none;filter:grayscale(100%)}.fetching .btn::after,.fetching .btn::before,.btn:disabled::before,.btn:disabled::after{opacity:0}.tabs{display:flex;border-bottom:1px solid var(--border, #e0e0e0);margin-bottom:1em;position:relative}.tabs::after{content:'';position:absolute;bottom:-1px;height:2px;width:var(--tab-width, 0);transform:translateX(var(--tab-x, 0));background-color:var(--primary, #1976d2);transition:transform 0.25s cubic-bezier(0.4, 0, 0.2, 1)}.tab{padding:0.5em 1.25em;cursor:pointer;font-size:0.875em;font-weight:500;color:var(--text-secondary, rgba(0, 0, 0, 0.6));position:relative;transition:all 0.2s ease-in-out;text-transform:uppercase;letter-spacing:0.0892857143em;user-select:none;white-space:nowrap;flex:1;text-align:center}.tab.active{color:var(--primary, #1976d2);background-color:var(--primary-light, rgba(25, 118, 210, 0.08))}.tab:hover:not(.active){background-color:rgba(0, 0, 0, 0.04);color:var(--text-primary, rgba(0, 0, 0, 0.87))}.tab:active:not(.active){background-color:rgba(0, 0, 0, 0.08);color:var(--text-primary, rgba(0, 0, 0, 0.87))}.tab-content{width:100%;padding-top:0.5em}.tab-pane{display:none}.tab-pane.active{display:block}",E=n=>f.querySelector(n),$=n=>f.querySelectorAll(n),T=()=>{a=!1;try{document.removeEventListener("keydown",_);const n=E(".dialog-container");n?(n.classList.add("closing"),setTimeout(()=>{try{document.documentElement.removeChild(b)}catch(d){console.error("移除对话框元素时出错:",d)}},312)):document.documentElement.removeChild(b)}catch(d){console.error("关闭对话框时出错:",d)}finally{document.removeEventListener("keydown",_)}},_=n=>{"Escape"===n.key&&T()};document.addEventListener("keydown",_);const L=document.createElement("style");L.textContent=k,f.appendChild(L);const C=n=>{const e=(new DOMParser).parseFromString(`<template>${n}</template>`,"text/html").querySelector("template");if(!e)throw new Error("Failed to parse HTML");return e.content};try{const n=C(w);f.appendChild(n)}catch(m){console.error("解析HTML时出错:",m);const n=document.createElement("div");n.className="fallback-dialog";const e=document.createElement("h3");e.textContent="NoLet Sender",e.className="fallback-title";const t=document.createElement("p");t.textContent=l.parseHtmlError||"解析 HTML 时出错",t.className="fallback-message";const o=document.createElement("button");o.className="fallback-close-btn",o.title=l.close||"关闭";const r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttribute("viewBox","0 0 24 24");const a=document.createElementNS("http://www.w3.org/2000/svg","path");a.setAttribute("d","M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"),r.appendChild(a),o.appendChild(r),o.onclick=T;const i=document.createElement("style");i.textContent=".fallback-dialog{position:fixed;top:50%;left:50%;transform:translate(-50%, -50%);background:white;padding:20px;border-radius:8px;box-shadow:0 4px 12px rgba(0, 0, 0, 0.15);z-index:2147483647}.fallback-title{margin-bottom:15px;font-size:18px;font-weight:600;min-width:200px}.fallback-message{margin-bottom:15px}.fallback-close-btn{margin-top:15px;padding:1px;background:#f0f0f0;border:1px solid #ccc;border-radius:4px;cursor:pointer;width:100%;height:30px;display:flex;align-items:center;justify-content:center;color:#d32f2f}.fallback-close-btn svg{width:20px;height:20px;fill:currentColor}.fallback-close-btn:hover{background-color:rgb(253, 237, 237);opacity:0.8}.fallback-close-btn:active{opacity:0.6;transition:opacity 0.2s}",n.appendChild(e),n.appendChild(t),n.appendChild(o),f.appendChild(i),f.appendChild(n)}const I=E(".dialog-container");I&&I.addEventListener("click",n=>{n.target===I&&T()});const S=E(".close-btn");S&&S.addEventListener("click",T);const P=E(".reload-preview"),A=E("#img-src"),z=E(".thumbnail"),N=E(".send-img-src"),M=E(".img-message"),F=n=>n.trim().startsWith("http://")||n.trim().startsWith("https://");P&&A&&z&&P.addEventListener("click",()=>{z.src=A.value.trim()});const R=E("#img-alt");N&&A&&N.addEventListener("click",()=>{const n=A.value.trim();let t=n;const o=/^(?:(\/\/)|(\/)|(?:\.\/)|(?:\.\.\/+))(.*)/,r=n.match(o);if(r){const[,e,o,,...a]=r,i=r[3];switch(!0){case!!e:t=`${window.location.protocol}${n}`;break;case!!o:t=`${window.location.origin}${n}`;break;case n.startsWith("./"):const r=window.location.pathname.substring(0,window.location.pathname.lastIndexOf("/")+1);t=`${window.location.origin}${r}${i}`;break;case n.startsWith("../"):{const e=window.location.pathname,o=(n.match(/\.\.\//g)||[]).length,r=e.split("/").filter(Boolean).slice(0,-o).join("/"),a=i.replace(/^(?:\.\.\/)*/,"");t=`${window.location.origin}/${r}/${a}`;break}}}if(F(t)){A.value=t,M&&(M.style.visibility="hidden");const n=R&&R.value?R.value.trim()||l.image||"图片":l.image||"图片";e("image",t,n)}else M&&(M.style.visibility="visible"),N.disabled=!0,setTimeout(()=>{N&&(N.disabled=!1,M&&(M.style.visibility="hidden"))},2e3)});const U=E(".send-img-alt");U&&R&&U.addEventListener("click",()=>{const n=R.value.trim();e("text",n,"图片替代文本")});const W=E(".send-current-text"),D=E("#current-text");W&&D&&W.addEventListener("click",()=>{const n=D.value.trim();e("text",n,"当前元素文本")});const j=E(".send-parent-text"),q=E("#parent-text");j&&q&&j.addEventListener("click",()=>{const n=q.value.trim();n&&"无父元素"!==n&&e("text",n,"父元素文本")});const B=E(".send-page-url"),H=E("#page-title"),O=E("#page-url");if(B&&H&&O&&B.addEventListener("click",()=>{const n=O.value.trim(),t=H.value.trim()||"网页链接";e("url",n,t)}),s){const n=E(".send-context-link"),t=E("#context-link-url");n&&t&&n.addEventListener("click",()=>{const n=t.value.trim();e("url",n,l.link||"链接")});const o=E(".send-context-selection"),r=E("#context-selection");o&&r&&o.addEventListener("click",()=>{const n=r.value.trim();e("text",n,"选中文本")})}const V=$(".tab"),Y=E(".tabs");if(Y){const n=E(".tab.active");if(n){const e=n.offsetWidth,t=n.offsetLeft;Y.style.setProperty("--tab-width",`${e}px`),Y.style.setProperty("--tab-x",`${t}px`)}V.forEach(n=>{n.addEventListener("click",()=>{V.forEach(n=>n.classList.remove("active")),n.classList.add("active");const e=n.offsetWidth,t=n.offsetLeft;Y.style.setProperty("--tab-width",`${e}px`),Y.style.setProperty("--tab-x",`${t}px`);if($(".tab-pane").forEach(n=>n.classList.remove("active")),n.classList.contains("tab-current")){const n=E(".current-content");n&&n.classList.add("active")}else if(n.classList.contains("tab-parent")){const n=E(".parent-content");n&&n.classList.add("active")}})})}}catch(m){console.error("显示对话框时出错:",m),alert(m instanceof Error?m.message:l.unknownError||"未知错误"),a=!1}}(s.contextInfo),Promise.resolve({success:!0}))}catch(c){console.error("显示对话框时出错:",c);const n=c instanceof Error?c.message:String(c);return Promise.resolve({success:!1,error:n})}if("cacheImage"===s.action){console.debug("收到缓存图片请求:",s);const{imageUrl:e,pushID:t}=s;return e&&t?async function(e,t){try{console.debug("开始缓存图片:",e,t);try{const r=await fetch(e);if(!r.ok)throw new Error(`HTTP ${r.status}`);const a=await r.blob();console.debug("图片数据获取成功，大小:",a.size,"bytes");const i=await a.arrayBuffer();try{return await async function(e,t,o){return new Promise((r,a)=>{const i=n.runtime.connect({name:"imageCache"});let s=!1;const l=setTimeout(()=>{s||(s=!0,i.disconnect(),a(new Error("Port 传输超时")))},3e4);i.onMessage.addListener(n=>{s||(n.success?(s=!0,clearTimeout(l),i.disconnect(),r()):(s=!0,clearTimeout(l),i.disconnect(),a(new Error(n.error||"Port 传输失败"))))}),i.onDisconnect.addListener(()=>{s||(s=!0,clearTimeout(l),a(new Error("Port 连接断开")))});try{i.postMessage({action:"saveImageCache",imageUrl:e,imageData:t,pushID:o})}catch(c){s=!0,clearTimeout(l),i.disconnect(),a(c)}})}(e,i,t),void console.debug("图片缓存保存成功 (Port):",e)}catch(o){console.warn("Port 传输失败，尝试 base64 兜底:",o);const r=await function(n){return new Promise((e,t)=>{const o=new FileReader;o.onload=()=>e(o.result),o.onerror=()=>t(new Error("Failed to convert blob to base64")),o.readAsDataURL(n)})}(a);return await async function(e,t,o){const r=await n.runtime.sendMessage({action:"saveImageCacheBase64",imageUrl:e,imageData:t,pushID:o});if(!r?.success)throw new Error(r?.error||"Base64 传输失败")}(e,r,t),void console.debug("图片缓存保存成功 (base64):",e)}}catch(r){console.warn("内容脚本获取图片失败 (可能是跨域)，尝试 background 兜底:",r);try{const o=await n.runtime.sendMessage({action:"fetchAndCacheImage",imageUrl:e,pushID:t});if(!o?.success)throw new Error(o?.error||"Background 兜底失败");console.debug("图片缓存保存成功 (background 兜底):",e)}catch(a){console.error("Background 兜底方案也失败，放弃缓存:",a)}}}catch(c){console.error("图片缓存过程失败:",c)}}(e,t).then(()=>{console.debug("图片缓存请求已发送:",e)}).catch(n=>{console.error("图片缓存失败:",n)}):console.warn("缓存图片请求缺少必要参数:",{imageUrl:e,pushID:t}),Promise.resolve({success:!0})}return Promise.resolve({success:!1,error:"Unknown action"})})}};const t=(...n)=>{console.debug};class o extends Event{constructor(n,e){super(o.EVENT_NAME,{}),this.newUrl=n,this.oldUrl=e}static EVENT_NAME=r("wxt:locationchange")}function r(e){return`${n?.runtime?.id}:element-analyzer:${e}`}class a{constructor(n,e){this.contentScriptName=n,this.options=e,this.abortController=new AbortController,this.isTopFrame?(this.listenForNewerScripts({ignoreFirstEvent:!0}),this.stopOldScripts()):this.listenForNewerScripts()}static SCRIPT_STARTED_MESSAGE_TYPE=r("wxt:content-script-started");isTopFrame=window.self===window.top;abortController;locationWatcher=function(n){let e,t;return{run(){null==e&&(t=new URL(location.href),e=n.setInterval(()=>{let n=new URL(location.href);n.href!==t.href&&(window.dispatchEvent(new o(n,t)),t=n)},1e3))}}}(this);receivedMessageIds=new Set;get signal(){return this.abortController.signal}abort(n){return this.abortController.abort(n)}get isInvalid(){return null==n.runtime.id&&this.notifyInvalidated(),this.signal.aborted}get isValid(){return!this.isInvalid}onInvalidated(n){return this.signal.addEventListener("abort",n),()=>this.signal.removeEventListener("abort",n)}block(){return new Promise(()=>{})}setInterval(n,e){const t=setInterval(()=>{this.isValid&&n()},e);return this.onInvalidated(()=>clearInterval(t)),t}setTimeout(n,e){const t=setTimeout(()=>{this.isValid&&n()},e);return this.onInvalidated(()=>clearTimeout(t)),t}requestAnimationFrame(n){const e=requestAnimationFrame((...e)=>{this.isValid&&n(...e)});return this.onInvalidated(()=>cancelAnimationFrame(e)),e}requestIdleCallback(n,e){const t=requestIdleCallback((...e)=>{this.signal.aborted||n(...e)},e);return this.onInvalidated(()=>cancelIdleCallback(t)),t}addEventListener(n,e,t,o){"wxt:locationchange"===e&&this.isValid&&this.locationWatcher.run(),n.addEventListener?.(e.startsWith("wxt:")?r(e):e,t,{...o,signal:this.signal})}notifyInvalidated(){this.abort("Content script context invalidated"),t(`Content script "${this.contentScriptName}" context invalidated`)}stopOldScripts(){window.postMessage({type:a.SCRIPT_STARTED_MESSAGE_TYPE,contentScriptName:this.contentScriptName,messageId:Math.random().toString(36).slice(2)},"*")}verifyScriptStartedEvent(n){const e=n.data?.type===a.SCRIPT_STARTED_MESSAGE_TYPE,t=n.data?.contentScriptName===this.contentScriptName,o=!this.receivedMessageIds.has(n.data?.messageId);return e&&t&&o}listenForNewerScripts(n){let e=!0;const t=t=>{if(this.verifyScriptStartedEvent(t)){this.receivedMessageIds.add(t.data.messageId);const o=e;if(e=!1,o&&n?.ignoreFirstEvent)return;this.notifyInvalidated()}};addEventListener("message",t),this.onInvalidated(()=>removeEventListener("message",t))}}const i=(...n)=>{console.error};return(async()=>{try{const{main:n,...t}=e,o=new a("element-analyzer",t);return await n(o)}catch(n){throw i('The content script "element-analyzer" crashed on startup!',n),n}})()}();
elementAnalyzer;